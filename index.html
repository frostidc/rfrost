<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Rclose Pixel Place - Admin Sistemi</title>
  <style>
    body { background: #111; color: white; text-align: center; font-family: sans-serif; }
    canvas { border: 2px solid #fff; margin-top: 20px; image-rendering: pixelated; }
    #colorPicker { margin: 10px; }
    button, input[type="file"] {
      padding: 10px;
      margin: 5px;
      background: #333;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #adminPanel {
      display: none;
    }
  </style>
</head>
<body>
  <h1>ðŸŽ¨ Rclose Pixel Place</h1>

  <input type="color" id="colorPicker" value="#ff0000">
  <canvas id="canvas" width="1000" height="1000"></canvas>

  <div id="adminPanel">
    <h3>ðŸ‘‘ Admin Panel</h3>
    <button id="clearBtn">ðŸ§¹ Tuvali Temizle</button><br>
    <input type="file" id="imageUpload" accept="image/*">
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDAJGgwGdI6ZgWaGkZfIT9WRcbBqHLUXWY",
      authDomain: "rclose-25d84.firebaseapp.com",
      projectId: "rclose-25d84",
      storageBucket: "rclose-25d84.firebasestorage.app",
      messagingSenderId: "697784540299",
      appId: "1:697784540299:web:a8425786862a02459a088e",
      measurementId: "G-ELTFR1KTWP",
      databaseURL: "https://rclose-25d84-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const gridSize = 10;
    const adminPanel = document.getElementById("adminPanel");

    let isAdmin = false;
    let pendingImageData = null;

    const pixelRef = ref(db, 'pixels');
    onValue(pixelRef, (snapshot) => {
      const data = snapshot.val();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (data) {
        for (let key in data) {
          const [x, y] = key.split('_').map(Number);
          const color = typeof data[key] === 'object' ? data[key].color : data[key];
          ctx.fillStyle = color;
          ctx.fillRect(x * gridSize, y * gridSize, gridSize, gridSize);
        }
      }
    });

    canvas.addEventListener("click", (e) => {
      const rect = canvas.getBoundingClientRect();
      const x = Math.floor((e.clientX - rect.left) / gridSize);
      const y = Math.floor((e.clientY - rect.top) / gridSize);
      const color = document.getElementById("colorPicker").value;
      const pixelKey = `${x}_${y}`;
      const pixelPath = ref(db, 'pixels/' + pixelKey);

      if (isAdmin && pendingImageData) {
        const { imageData, width, height } = pendingImageData;

        for (let dy = 0; dy < height; dy++) {
          for (let dx = 0; dx < width; dx++) {
            const i = (dy * width + dx) * 4;
            const r = imageData[i];
            const g = imageData[i + 1];
            const b = imageData[i + 2];
            const a = imageData[i + 3];
            if (a < 10) continue; // saydam pikseli atla

            const hex = `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
            const px = x + dx;
            const py = y + dy;

            if (px * gridSize < canvas.width && py * gridSize < canvas.height) {
              ctx.fillStyle = hex;
              ctx.fillRect(px * gridSize, py * gridSize, gridSize, gridSize);
              set(ref(db, 'pixels/' + `${px}_${py}`), { color: hex, locked: true });
            }
          }
        }

        pendingImageData = null;
        alert("âœ… Resim baÅŸarÄ±yla yerleÅŸtirildi.");
        return;
      }

      onValue(pixelPath, (snapshot) => {
        const data = snapshot.val();
        if (data && data.locked && !isAdmin) {
          ctx.fillStyle = color;
          ctx.fillRect(x * gridSize, y * gridSize, gridSize, gridSize);
          setTimeout(() => {
            ctx.fillStyle = data.color;
            ctx.fillRect(x * gridSize, y * gridSize, gridSize, gridSize);
          }, 1000);
        } else {
          ctx.fillStyle = color;
          ctx.fillRect(x * gridSize, y * gridSize, gridSize, gridSize);
          set(pixelPath, isAdmin ? { color, locked: false } : { color });
        }
      }, { onlyOnce: true });
    });

    document.getElementById("clearBtn").onclick = () => {
      if (confirm("TÃ¼m tuvali silmek istiyor musun?")) {
        remove(pixelRef);
      }
    };

    document.getElementById("imageUpload").addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const width = img.width;
          const height = img.height;

          const tempCanvas = document.createElement("canvas");
          tempCanvas.width = width;
          tempCanvas.height = height;
          const tempCtx = tempCanvas.getContext("2d");
          tempCtx.drawImage(img, 0, 0, width, height);
          const imageData = tempCtx.getImageData(0, 0, width, height).data;

          pendingImageData = { imageData, width, height };
          alert(`ðŸŸ¡ Resim (${width}x${height}) yÃ¼klendi. Tuvalde baÅŸlangÄ±Ã§ noktasÄ± seÃ§.`);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    });

    // Admin tuÅŸlarÄ± (f + r + o + s + t)
    const pressedKeys = new Set();
    const targetKeys = ['f', 'r', 'o', 's', 't'];

    document.addEventListener("keydown", (e) => {
      pressedKeys.add(e.key.toLowerCase());
      if (targetKeys.every(k => pressedKeys.has(k))) {
        isAdmin = true;
        adminPanel.style.display = "block";
        alert("âœ… Admin panel aktif!");
      }
    });

    document.addEventListener("keyup", (e) => {
      pressedKeys.delete(e.key.toLowerCase());
    });
  </script>
</body>
</html>
